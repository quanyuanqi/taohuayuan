<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>公告栏</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.8;
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }

    /* 页面左上角标题 */
    .page-title {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 2.0rem;
      font-weight: bold;
      color: #0056b3;
      text-decoration: none;
    }

    /* 自定义多行标题样式 */
    .title-container {
      text-align: center;
      margin: 60px auto 24px;
      max-width: 600px;
    }
    .title-main {
      font-size: 1.8rem;
      color: #0056b3;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .title-sub {
      font-size: 1.3rem;
      color: #333;
      font-weight: normal;
      margin-bottom: 4px;
    }
    .title-tag {
      font-size: 1.0rem;
      color: #666;
      font-weight: normal;
    }

    /* 公告列表样式 */
    .bulletin-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .bulletin-item {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .bulletin-title {
      padding: 16px 20px;
      font-size: 1.05rem;
      color: #0077cc;
      text-decoration: none;
      display: block;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .bulletin-title:hover {
      background-color: #f0f5ff;
      transform: translateY(-1px);
    }

    .bulletin-title:active {
      background-color: #e6f0ff;
    }

    .bulletin-content {
      padding: 0 20px 16px;
      font-size: 0.98rem;
      color: #333;
      line-height: 1.7;
    }

    .bulletin-content.full {
      display: block;
    }

    .bulletin-content.preview {
      display: block;
    }

    .attachments {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      color: #666;
      font-size: 0.9rem;
    }

    .attachment-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      background: #0077cc;
      border-radius: 2px;
      text-align: center;
      line-height: 16px;
      color: white;
      font-size: 0.7rem;
    }

    footer {
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      margin-top: 30px;
    }

    /* 移动端适配 */
    @media (max-width: 480px) {
      .page-title {
        font-size: 1.8rem;
        top: 15px;
        left: 15px;
      }
      .title-main {
        font-size: 1.6rem;
      }
      .title-sub {
        font-size: 1.2rem;
      }
      .title-tag {
        font-size: 0.95rem;
      }
      .bulletin-title {
        font-size: 1.0rem;
        padding: 14px 16px;
      }
      .bulletin-content {
        font-size: 0.95rem;
        padding: 0 16px 14px;
      }
      .bulletin-list {
        gap: 12px;
      }
      footer {
        font-size: 0.85rem;
      }
      body {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <!-- 左上角“桃花源”标题（带链接） -->
  <a href="https://www.taohuayuan.org.cn" target="_blank" class="page-title">桃花源</a>

  <!-- 页面主标题 -->
  <div class="title-container">
    <div class="title-main">小区公告栏</div>
    <div class="title-sub">重要通知与信息</div>
    <div class="title-tag">持续更新</div>
  </div>

  <!-- 公告列表 -->
  <div class="bulletin-list" id="bulletin-list">
    <p style="text-align: center; color: #666;">正在加载公告...</p>
  </div>

  <!-- 页脚 -->
  <footer>
    <p>更新时间：2025年10月21日</p>
  </footer>

  <script>
    // 加载公告列表
    async function loadBulletins() {
      try {
        // ✅ 更新 API 路径
        const response = await fetch('/api/bulletin');
        if (!response.ok) throw new Error('加载失败');
        
        const bulletins = await response.json();
        renderBulletins(bulletins);
      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('bulletin-list').innerHTML = '<p style="text-align: center; color: #666;">加载公告失败</p>';
      }
    }

    // 渲染公告列表
    function renderBulletins(bulletins) {
      if (!bulletins || bulletins.length === 0) {
        document.getElementById('bulletin-list').innerHTML = '<p style="text-align: center; color: #666;">暂无公告</p>';
        return;
      }

      // 按时间倒序排列
      bulletins.sort((a, b) => new Date(b.date) - new Date(a.date));

      const html = bulletins.map(bulletin => {
        const preview = bulletin.content.length > 60 
          ? bulletin.content.slice(0, 60) + '...' 
          : bulletin.content;
        
        // 转义 HTML 并处理超链接
        const escapedContent = escapeHtml(bulletin.content);
        const contentWithLinks = escapedContent.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        
        const previewWithLinks = escapeHtml(preview).replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

        return `
          <div class="bulletin-item">
            <div class="bulletin-title" onclick="toggleBulletin('${bulletin.id}')">
              ${escapeHtml(bulletin.title)}
            </div>
            <div class="bulletin-content preview" id="content-${bulletin.id}">
              ${previewWithLinks}
            </div>
            <div class="bulletin-content full" id="full-content-${bulletin.id}" style="display: none;">
              ${contentWithLinks}
              ${renderAttachments(bulletin.attachments)}
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('bulletin-list').innerHTML = html;
    }

    // 渲染附件
    function renderAttachments(attachments) {
      if (!attachments || attachments.length === 0) return '';
      
      return `
        <div class="attachments">
          <div style="font-weight: bold; margin-bottom: 8px;">附件：</div>
          ${attachments.map(attachment => `
            <div class="attachment-item">
              <span class="attachment-icon">📁</span>
              <a href="${attachment.url}" target="_blank" style="color: #0077cc; text-decoration: none;">
                ${escapeHtml(attachment.name)}
              </a>
              <span style="color: #999;">(${formatFileSize(attachment.size)})</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 切换公告内容显示
    window.toggleBulletin = function(id) {
      const previewEl = document.getElementById(`content-${id}`);
      const fullEl = document.getElementById(`full-content-${id}`);
      
      if (fullEl.style.display === 'block') {
        // 收起
        fullEl.style.display = 'none';
        previewEl.style.display = 'block';
      } else {
        // 展开
        previewEl.style.display = 'none';
        fullEl.style.display = 'block';
      }
    };

    // 转义 HTML
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    // 初始化
    loadBulletins();
  </script>
</body>
</html>
