<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°åŒºå»ºè¨€çŒ®ç­–</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.8;
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }

    /* é¡µé¢å·¦ä¸Šè§’æ ‡é¢˜ */
    .page-title {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 2.0rem;
      font-weight: bold;
      color: #0056b3;
      text-decoration: none;
    }

    /* è‡ªå®šä¹‰å¤šè¡Œæ ‡é¢˜æ ·å¼ */
    .title-container {
      text-align: center;
      margin: 60px auto 24px;
      max-width: 600px;
    }
    .title-main {
      font-size: 1.8rem;
      color: #0056b3;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .title-sub {
      font-size: 1.3rem;
      color: #333;
      font-weight: normal;
      margin-bottom: 4px;
    }
    .title-tag {
      font-size: 1.0rem;
      color: #666;
      font-weight: normal;
      text-decoration: none;
      display: inline-block;
      margin-top: 4px;
      transition: color 0.2s ease;
    }

    .title-tag:hover {
      color: #0056b3;
    }

    /* è¡¨å•æ ·å¼ */
    .form-container {
      max-width: 600px;
      margin: 0 auto 30px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.2s;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #0077cc;
    }

    button {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    button:hover {
      background-color: #0066b3;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .attachments {
      margin-top: 15px;
    }

    .attachment-list {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #666;
    }

    .attachment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .error {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
    }

    .success {
      color: #28a745;
      margin-top: 10px;
      text-align: center;
    }

    /* å…¬å‘Šåˆ—è¡¨æ ·å¼ */
    .advice-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .advice-item {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .advice-title {
      padding: 16px 20px;
      font-size: 1.05rem;
      color: #0077cc;
      text-decoration: none;
      display: block;
      font-weight: bold;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .advice-title:hover {
      background-color: #f0f5ff;
      transform: translateY(-1px);
    }

    .advice-title:active {
      background-color: #e6f0ff;
    }

    .advice-meta {
      padding: 0 20px 8px;
      font-size: 0.85rem;
      color: #888;
    }

    .advice-content {
      padding: 0 20px 16px;
      font-size: 0.98rem;
      color: #333;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .advice-content.preview {
      display: block;
    }

    .advice-content.full {
      display: block;
    }

    .attachments {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      color: #666;
      font-size: 0.9rem;
    }

    .attachment-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      background: #0077cc;
      border-radius: 2px;
      text-align: center;
      line-height: 16px;
      color: white;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .attachment-download-btn {
      padding: 4px 8px;
      font-size: 0.75rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.2s;
    }

    .attachment-download-btn:hover {
      background-color: #218838;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    .comment-box {
      margin-top: 10px;
      padding: 12px;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      background: #fafafa;
    }
    .comment-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .comment-author-input {
      flex: 0 0 180px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      background: #fff;
    }
    .comment-content-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      min-height: 80px;
      resize: vertical;
      background: #fff;
    }
    .comment-submit-btn {
      padding: 10px 14px;
      background: #0077cc;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .comment-submit-btn:hover {
      background: #0066b3;
    }
    @media (max-width: 480px) {
      .page-title {
        font-size: 1.8rem;
        top: 15px;
        left: 15px;
      }
      .title-main {
        font-size: 1.6rem;
      }
      .title-sub {
        font-size: 1.2rem;
      }
      .title-tag {
        font-size: 0.95rem;
      }
      .advice-title {
        font-size: 1.0rem;
        padding: 14px 16px;
      }
      .advice-content {
        font-size: 0.95rem;
        padding: 0 16px 14px;
      }
      .advice-list {
        gap: 12px;
      }
      body {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <!-- å·¦ä¸Šè§’"æ¡ƒèŠ±æº"æ ‡é¢˜ï¼ˆå¸¦é“¾æ¥ï¼‰ -->
  <a href="https://www.taohuayuan.org.cn" target="_blank" class="page-title">æ¡ƒèŠ±æº</a>

  <!-- é¡µé¢ä¸»æ ‡é¢˜ -->
  <div class="title-container">
    <div class="title-main">å»ºè¨€çŒ®ç­–</div>
    <div class="title-sub">è®©å°åŒºæ›´ç¾å¥½ï¼</div>
    <a class="title-tag" href="bulletin-board.html">ç‚¹å‡»é˜…è¯»ä¸šå§”ä¼šå…¬å‘Š</a>
  </div>

  <!-- æäº¤è¡¨å• -->
  <div class="form-container">
    <h3 style="margin-bottom: 20px;">æäº¤å»ºè®®</h3>
    <form id="adviceForm">
      <div class="form-group">
        <label for="advice-author">ç½‘åï¼š</label>
        <input type="text" id="advice-author" name="author" placeholder="è¯·è¾“å…¥æ‚¨çš„ç½‘åï¼ˆå¯é€‰ï¼‰" maxlength="50" />
      </div>
      <div class="form-group">
        <label for="advice-title">æ ‡é¢˜ï¼š</label>
        <input type="text" id="advice-title" name="title" placeholder="è¯·è¾“å…¥æ ‡é¢˜" maxlength="100" required />
      </div>
      <div class="form-group">
        <label for="advice-content">å†…å®¹ï¼š</label>
        <textarea id="advice-content" name="content" rows="6" placeholder="è¯·è¾“å…¥å†…å®¹ï¼Œæ”¯æŒè¶…é“¾æ¥" maxlength="2000" required></textarea>
      </div>
      <div class="form-group attachments">
        <label for="advice-attachments">é™„ä»¶ï¼ˆå›¾ç‰‡/æ–‡æ¡£ï¼‰ï¼š</label>
        <input type="file" id="advice-attachments" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.xls,.xlsx" />
        <div id="attachment-preview" class="attachment-list"></div>
      </div>
      <button type="submit" id="submit-btn">æäº¤</button>
      <div id="submit-message"></div>
    </form>
  </div>

  <!-- å»ºè¨€åˆ—è¡¨ -->
  <div class="advice-list" id="advice-list">
    <p style="text-align: center; color: #666;">æ­£åœ¨åŠ è½½å»ºè¨€...</p>
  </div>

  <script>
    // DOM å…ƒç´ 
    const form = document.getElementById('adviceForm');
    const submitBtn = document.getElementById('submit-btn');
    const submitMessage = document.getElementById('submit-message');
    const adviceAuthor = document.getElementById('advice-author');
    const adviceTitle = document.getElementById('advice-title');
    const adviceContent = document.getElementById('advice-content');
    const adviceAttachments = document.getElementById('advice-attachments');
    const attachmentPreview = document.getElementById('attachment-preview');
    const adviceList = document.getElementById('advice-list');

    // é™„ä»¶é¢„è§ˆ
    adviceAttachments.addEventListener('change', () => {
      const files = Array.from(adviceAttachments.files);
      attachmentPreview.innerHTML = files.map(file => `
        <div class="attachment-item">
          <span>${escapeHtml(file.name)}</span>
          <span>${(file.size / 1024).toFixed(1)} KB</span>
        </div>
      `).join('');
    });

    // æäº¤è¡¨å•
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitMessage.innerHTML = '<div style="text-align: center; color: #666;">æ­£åœ¨æäº¤...</div>';
      
      const author = adviceAuthor.value.trim();
      const title = adviceTitle.value.trim();
      const content = adviceContent.value.trim();
      const files = Array.from(adviceAttachments.files);

      if (!title || !content) {
        submitMessage.innerHTML = '<div class="error">æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º</div>';
        return;
      }

      if (files.length > 0) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        
        for (const file of files) {
          if (!allowedTypes.includes(file.type) && file.type !== '') {
            submitMessage.innerHTML = `<div class="error">æ–‡ä»¶ç±»å‹ä¸æ”¯æŒï¼š${escapeHtml(file.name)}</div>`;
            return;
          }
        }
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'æäº¤ä¸­...';

        // å‡†å¤‡æäº¤æ•°æ®
        const adviceData = {
          title,
          content,
          author: author || 'åŒ¿å',
          attachments: []
        };

        // å¦‚æœæœ‰é™„ä»¶ï¼Œä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        if (files.length > 0) {
          const uploadPromises = files.map(async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('key', `advice-attachments/${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${file.name}`);

            // ä½¿ç”¨å…¬å¼€ä¸Šä¼ ç«¯ç‚¹
            const uploadResponse = await fetch('/api/upload-advice', {
              method: 'POST',
              body: formData
            });

            if (!uploadResponse.ok) {
              const error = await uploadResponse.json();
              throw new Error(error.error || 'é™„ä»¶ä¸Šä¼ å¤±è´¥');
            }

            const uploadData = await uploadResponse.json();
            
            // ç›´æ¥ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
            const directUploadFormData = new FormData();
            directUploadFormData.append('token', uploadData.uploadToken);
            directUploadFormData.append('key', uploadData.key);
            let uploadMime = file.type || '';
            if (!uploadMime && /\.txt$/i.test(file.name)) {
              uploadMime = 'text/plain; charset=utf-8';
            }
            if (uploadMime) {
              directUploadFormData.append('mimeType', uploadMime.includes('text/plain') && !uploadMime.includes('charset') ? 'text/plain; charset=utf-8' : uploadMime);
            }
            directUploadFormData.append('file', file);

            const directUploadResponse = await fetch('https://up-z2.qiniup.com/', {
              method: 'POST',
              body: directUploadFormData
            });

            if (!directUploadResponse.ok) {
              const errorText = await directUploadResponse.text();
              console.error('Direct upload failed:', errorText);
              throw new Error(`é™„ä»¶ä¸Šä¼ å¤±è´¥: ${errorText}`);
            }

            return {
              name: file.name,
              url: uploadData.url,
              size: file.size
            };
          });

          adviceData.attachments = await Promise.all(uploadPromises);
        }

        // æäº¤å»ºè¨€
        const response = await fetch('/api/advice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(adviceData)
        });

        if (response.ok) {
          submitMessage.innerHTML = '<div class="success">æäº¤æˆåŠŸï¼è¯·ç­‰å¾…å®¡æ ¸åæ˜¾ç¤ºï¼Œä¸€èˆ¬30åˆ†é’Ÿå·¦å³ã€‚</div>';
          form.reset();
          attachmentPreview.innerHTML = '';
        } else {
          const error = await response.json();
          throw new Error(error.error || 'æäº¤å¤±è´¥');
        }
      } catch (err) {
        console.error('Submit error:', err);
        submitMessage.innerHTML = `<div class="error">æäº¤å¤±è´¥ï¼š${err.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
      }
    });

    // åŠ è½½å»ºè¨€åˆ—è¡¨
    async function loadAdvices() {
      try {
        const response = await fetch('/api/advice');
        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
        
        const advices = await response.json();
        renderAdvices(advices);
      } catch (err) {
        console.error('Load error:', err);
        adviceList.innerHTML = '<p style="text-align: center; color: #666;">åŠ è½½å»ºè¨€å¤±è´¥</p>';
      }
    }

    // æ¸²æŸ“å»ºè¨€åˆ—è¡¨
    function renderAdvices(advices) {
      if (!advices || advices.length === 0) {
        adviceList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å»ºè¨€</p>';
        return;
      }

      // æŒ‰æ—¶é—´å€’åºæ’åˆ—
      advices.sort((a, b) => new Date(b.date) - new Date(a.date));

      const html = advices.map(advice => {
        const preview = advice.content.length > 60 
          ? advice.content.slice(0, 60) + '...' 
          : advice.content;
        
        // è½¬ä¹‰ HTML å¹¶å¤„ç†è¶…é“¾æ¥
        const escapedContent = escapeHtml(advice.content);
        const contentWithLinks = escapedContent.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        
        const previewWithLinks = escapeHtml(preview).replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

        const repliesHtml = Array.isArray(advice.replies) && advice.replies.length > 0
          ? `<div class="attachments" style="border-top:none;margin-top:8px;padding-top:0;">${advice.replies.map(r => {
              const d = r.date ? new Date(r.date) : null;
              const dateStr = d && !isNaN(d) ? `${d.getFullYear()}å¹´${(d.getMonth()+1).toString().padStart(2,'0')}æœˆ${d.getDate().toString().padStart(2,'0')}æ—¥` : '';
              return `<div style="margin:6px 0;">
                <span style="color:#d00;font-weight:bold;margin-right:6px;">ä¸šå§”ä¼šå›å¤</span>
                ${dateStr ? `<span style="color:#888;font-size:0.85rem;margin-right:6px;">${dateStr}</span>` : ''}
                <span>${escapeHtml(r.content)}</span>
              </div>`;
            }).join('')}</div>`
          : '';

        const commentsHtml = Array.isArray(advice.comments) && advice.comments.length > 0
          ? `<div class="attachments"><div style="font-weight:bold;margin-bottom:8px;">è¯„è®ºï¼š</div>${advice.comments.map(c => `<div style="margin:6px 0;"><span style="color:#555;margin-right:6px;">${escapeHtml(c.author || 'åŒ¿å')}</span><span>${escapeHtml(c.content)}</span></div>`).join('')}</div>`
          : '';

        const commentForm = `<div class="comment-box" onclick="event.stopPropagation();">
          <div style="font-weight:bold;margin-bottom:8px;">æˆ‘è¦è¯„è®ºï¼š</div>
          <div style="margin-bottom:8px;" onclick="event.stopPropagation();">
            <input type="text" id="c-author-${advice.id}" class="comment-author-input" placeholder="ç½‘åï¼ˆå¯é€‰ï¼‰" style="width:100%; max-width: 360px;" />
          </div>
          <div style="margin-bottom:8px;" onclick="event.stopPropagation();">
            <textarea id="c-content-${advice.id}" class="comment-content-input" placeholder="è¯„è®ºå†…å®¹" style="width:100%;"></textarea>
          </div>
          <div style="margin-bottom:8px;" onclick="event.stopPropagation();">
            <button class="comment-submit-btn" onclick="event.stopPropagation(); submitComment('${advice.id}')">æäº¤</button>
          </div>
          <div id="c-msg-${advice.id}" style="font-size:0.9rem;color:#666;"></div>
        </div>`;

        return `<div class="advice-item"><div class="advice-title" onclick="toggleAdvice('${advice.id}')">${escapeHtml(advice.title)}</div><div class="advice-meta">${escapeHtml(advice.author)} Â· ${new Date(advice.date).toLocaleString('zh-CN')}</div><div class="advice-content preview" id="content-${advice.id}">${previewWithLinks}</div><div class="advice-content full" id="full-content-${advice.id}" style="display: none;">${contentWithLinks}${repliesHtml}${renderAttachments(advice.attachments)}${commentsHtml}${commentForm}</div></div>`;
      }).join('');

      adviceList.innerHTML = html;
    }

    // æ¸²æŸ“é™„ä»¶
    function renderAttachments(attachments) {
      if (!attachments || attachments.length === 0) return '';
      
      return `<div class="attachments"><div style="font-weight: bold; margin-bottom: 8px;">é™„ä»¶ï¼š</div>${attachments.map(attachment => {
        const escapedUrl = attachment.url.replace(/\"/g, '&quot;').replace(/'/g, '&#39;');
        const isWord = /\.(docx?)$/i.test(attachment.name || '');
        const officeViewer = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(attachment.url)}`;
        const viewUrl = isWord ? officeViewer : escapedUrl;
        return `<div class="attachment-item"><a href="${viewUrl}" target="_blank" style="display: flex; align-items: center; gap: 8px; color: #0077cc; text-decoration: none; flex: 1;"><span class="attachment-icon">ğŸ“</span><span>${escapeHtml(attachment.name)}</span></a><a href="${escapedUrl}" download="${escapeHtml(attachment.name)}" class="attachment-download-btn">ä¸‹è½½</a><span style="color: #999; margin-left: 8px;">(${formatFileSize(attachment.size)})</span></div>`;
      }).join('')}</div>`;
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // åˆ‡æ¢å»ºè¨€å†…å®¹æ˜¾ç¤º
    window.toggleAdvice = function(id) {
      const previewEl = document.getElementById(`content-${id}`);
      const fullEl = document.getElementById(`full-content-${id}`);
      
      if (fullEl.style.display === 'block') {
        // æ”¶èµ·
        fullEl.style.display = 'none';
        previewEl.style.display = 'block';
      } else {
        // å±•å¼€
        previewEl.style.display = 'none';
        fullEl.style.display = 'block';
      }
    };

    // è½¬ä¹‰ HTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    // æäº¤è¯„è®º
    window.submitComment = async function(id) {
      const authorInput = document.getElementById(`c-author-${id}`);
      const contentInput = document.getElementById(`c-content-${id}`);
      const msgEl = document.getElementById(`c-msg-${id}`);
      const author = (authorInput?.value || '').trim();
      const content = (contentInput?.value || '').trim();
      if (!content) {
        msgEl.textContent = 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º';
        msgEl.style.color = '#dc3545';
        return;
      }
      msgEl.textContent = 'æ­£åœ¨æäº¤...';
      msgEl.style.color = '#666';
      try {
        const res = await fetch('/api/advice-comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adviceId: id, author, content })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'æäº¤å¤±è´¥');
        }
        msgEl.textContent = 'æäº¤æˆåŠŸ';
        msgEl.style.color = '#28a745';
        if (authorInput) authorInput.value = '';
        if (contentInput) contentInput.value = '';
        // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°è¯„è®º
        loadAdvices();
      } catch (e) {
        msgEl.textContent = `æäº¤å¤±è´¥ï¼š${e.message}`;
        msgEl.style.color = '#dc3545';
      }
    }

    // åˆå§‹åŒ–
    loadAdvices();
  </script>
</body>
</html>
