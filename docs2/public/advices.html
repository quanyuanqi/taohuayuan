<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°åŒºå»ºè¨€çŒ®ç­–</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.8;
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }

    /* é¡µé¢å·¦ä¸Šè§’æ ‡é¢˜ */
    .page-title {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 2.0rem;
      font-weight: bold;
      color: #0056b3;
      text-decoration: none;
    }

    /* è‡ªå®šä¹‰å¤šè¡Œæ ‡é¢˜æ ·å¼ */
    .title-container {
      text-align: center;
      margin: 60px auto 24px;
      max-width: 600px;
    }
    .title-main {
      font-size: 1.8rem;
      color: #0056b3;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .title-sub {
      font-size: 1.3rem;
      color: #333;
      font-weight: normal;
      margin-bottom: 4px;
    }
    .title-tag {
      font-size: 1.0rem;
      color: #666;
      font-weight: normal;
      text-decoration: none;
      display: inline-block;
      margin-top: 4px;
      transition: color 0.2s ease;
    }

    .title-tag:hover {
      color: #0056b3;
    }

    /* è¡¨å•æ ·å¼ */
    .form-container {
      max-width: 600px;
      margin: 0 auto 30px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

.anonymous-option {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 10px;

  /* ç¡®ä¿å®¹å™¨æœ¬èº«å·¦å¯¹é½ */
  text-align: left;
  padding-left: 0;
  
  /* é¿å…å› çˆ¶å®¹å™¨ padding æˆ– margin å¯¼è‡´åç§» */
  display: flex;
  align-items: center;
}

.anonymous-option input[type="checkbox"] {
  margin: 0;            /* å»æ‰é»˜è®¤ margin */
  margin-right: 4px;     /* å¤é€‰æ¡†ä¸æ–‡å­—é—´è· */
  vertical-align: middle;
}

.anonymous-option label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 400;
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0;
  padding-left: 0;

  /* <<< å…³é”®éƒ¨åˆ†ï¼šç¦æ­¢æ¢è¡Œ */
  white-space: nowrap;
  flex-wrap: nowrap;
}

.advice-detail-block {
  margin-bottom: 0 !important;
  line-height: 1.4 !important;
}

    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }



    input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.2s;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #0077cc;
    }

    button {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    button:hover {
      background-color: #0066b3;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .attachments {
      margin-top: 15px;
    }

    .attachment-list {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #666;
    }

    .attachment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .error {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
    }

    .success {
      color: #28a745;
      margin-top: 10px;
      text-align: center;
    }

    /* å…¬å‘Šåˆ—è¡¨æ ·å¼ */
    .advice-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .advice-item {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .advice-title {
      padding: 16px 20px;
      font-size: 1.05rem;
      color: #0077cc;
      text-decoration: none;
      display: block;
      font-weight: bold;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .advice-title:hover {
      background-color: #f0f5ff;
      transform: translateY(-1px);
    }

    .advice-title:active {
      background-color: #e6f0ff;
    }

    .advice-meta {
      padding: 0 20px 8px;
      font-size: 0.85rem;
      color: #888;
    }

    .advice-content {
      padding: 0 20px 16px;
      font-size: 0.98rem;
      color: #333;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .advice-content.preview {
      display: block;
    }

    .advice-content.full {
      display: block;
    }

    .attachments {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      color: #666;
      font-size: 0.9rem;
    }

    .attachment-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      background: #0077cc;
      border-radius: 2px;
      text-align: center;
      line-height: 16px;
      color: white;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .attachment-download-btn {
      padding: 4px 8px;
      font-size: 0.75rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.2s;
    }

    .attachment-download-btn:hover {
      background-color: #218838;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    .comment-box {
      margin-top: 2px;
      padding: 6px;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      background: #fafafa;
    }
    .comment-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .comment-author-input {
      flex: 0 0 180px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      background: #fff;
    }
    .comment-content-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      min-height: 64px;
      resize: vertical;
      background: #fff;
    }
    .comment-submit-btn {
      padding: 10px 14px;
      background: #0077cc;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .comment-submit-btn:hover {
      background: #0066b3;
    }

/* ä¿®å¤å»ºè¨€è¯¦æƒ…çš„è¡Œé—´è·ï¼ˆè¦†ç›–è¡Œå†… styleï¼‰ */
.advice-detail-line {
  margin: 0 !important;
  padding: 0 !important;
  line-height: 1.2 !important; /* ä½ å¯åŠ å¤§åˆ°1.3/1.4ï¼Œæ ¹æ®æ•ˆæœå¾®è°ƒ */
}


    
    .readonly-input {
      background-color: #f1f1f1;
      color: #999;
    }
    .readonly-label {
      color: #999!important;
    }
    @media (max-width: 480px) {
      .page-title {
        font-size: 1.8rem;
        top: 15px;
        left: 15px;
      }
      .title-main {
        font-size: 1.6rem;
      }
      .title-sub {
        font-size: 1.2rem;
      }
      .title-tag {
        font-size: 0.95rem;
      }
      .advice-title {
        font-size: 1.0rem;
        padding: 14px 16px;
      }
      .advice-content {
        font-size: 0.95rem;
        padding: 0 16px 14px;
      }
      .advice-list {
        gap: 12px;
      }
      body {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <!-- å·¦ä¸Šè§’"æ¡ƒèŠ±æº"æ ‡é¢˜ï¼ˆå¸¦é“¾æ¥ï¼‰ -->
  <a href="https://www.taohuayuan.org.cn" target="_blank" class="page-title">æ¡ƒèŠ±æº</a>

  <!-- é¡µé¢ä¸»æ ‡é¢˜ -->
  <div class="title-container">
    <div class="title-main">å»ºè¨€çŒ®ç­–</div>
    <div class="title-sub">è®©å°åŒºæ›´ç¾å¥½ï¼</div>
    <a class="title-tag" href="bulletin-board.html">ç‚¹å‡»é˜…è¯»ä¸šå§”ä¼šå…¬å‘Š</a>
  </div>

  <!-- æäº¤è¡¨å• -->
  <div class="form-container">
    <h3 style="margin-bottom: 20px;">æäº¤ä¿¡æ¯</h3>
    <form id="adviceForm">
      <div class="anonymous-option">
        <label style="display:flex; align-items:center; gap:4px;">
          <input type="checkbox" id="anonymous-checkbox" />
          <span>ç‚¹å‡»å‹¾é€‰å°æ–¹æ¡†ï¼ŒåŒ¿åæäº¤ä¿¡æ¯</span>
        </label>
      </div>
      <div class="form-group">
        <label for="advice-name" class="field-label">å§“åï¼š</label>
        <input type="text" id="advice-name" name="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="50" required />
      </div>
      <div class="form-group">
        <label for="advice-building" class="field-label">æ¥¼æ ‹å·ï¼š</label>
        <input type="text" id="advice-building" name="building" placeholder="è¯·è¾“å…¥æ¥¼æ ‹å·" maxlength="100" required />
      </div>
      <div class="form-group">
        <label for="advice-contact" class="field-label">è”ç³»æ–¹å¼ï¼ˆç”µè¯ï¼‰ï¼š</label>
        <input type="tel" id="advice-contact" name="contact" placeholder="è¯·è¾“å…¥ç”µè¯å·ç " maxlength="30" required />
      </div>
      <div class="form-group">
        <label for="advice-description">å†…å®¹æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <textarea id="advice-description" name="description" rows="6" placeholder="è¯·è¾“å…¥å†…å®¹ï¼Œæ”¯æŒè¶…é“¾æ¥" maxlength="2000"></textarea>
        <div id="description-count" style="text-align: right; color: #666; font-size: 0.85rem; margin-top: 4px;">0/1000 æ±‰å­—</div>
      </div>
      <div class="form-group attachments">
        <label for="advice-attachments">é™„ä»¶ï¼ˆå›¾ç‰‡/æ–‡æ¡£ï¼‰ï¼š</label>
        <input type="file" id="advice-attachments" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.xls,.xlsx" />
        <div id="attachment-preview" class="attachment-list"></div>
      </div>
      <button type="submit" id="submit-btn">æäº¤ä¿¡æ¯</button>
      <div id="submit-message"></div>
    </form>
  </div>

  <!-- å»ºè¨€åˆ—è¡¨ -->
  <div class="advice-list" id="advice-list">
    <p style="text-align: center; color: #666;">æ­£åœ¨åŠ è½½å»ºè¨€...</p>
  </div>

  <script>
    // DOM å…ƒç´ 
    const form = document.getElementById('adviceForm');
    const submitBtn = document.getElementById('submit-btn');
    const submitMessage = document.getElementById('submit-message');
    const adviceName = document.getElementById('advice-name');
    const adviceBuilding = document.getElementById('advice-building');
    const adviceContact = document.getElementById('advice-contact');
    const adviceDescription = document.getElementById('advice-description');
    const adviceAttachments = document.getElementById('advice-attachments');
    const attachmentPreview = document.getElementById('attachment-preview');
    const adviceList = document.getElementById('advice-list');
    const descriptionCount = document.getElementById('description-count');
    const anonymousCheckbox = document.getElementById('anonymous-checkbox');
    const fieldLabels = document.querySelectorAll('.field-label');

    // äº‹ä»¶æè¿°å­—æ•°ç»Ÿè®¡
    adviceDescription.addEventListener('input', () => {
      const text = adviceDescription.value;
      const chineseCharCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
      descriptionCount.textContent = `${chineseCharCount}/1000 æ±‰å­—`;
      if (chineseCharCount > 1000) {
        descriptionCount.style.color = '#dc3545';
      } else {
        descriptionCount.style.color = '#666';
      }
    });
    adviceDescription.dispatchEvent(new Event('input'));

    // åŒ¿åé€‰é¡¹
    anonymousCheckbox.addEventListener('change', handleAnonymousToggle);
    handleAnonymousToggle();

    // é™„ä»¶é¢„è§ˆ
    adviceAttachments.addEventListener('change', () => {
      const files = Array.from(adviceAttachments.files);
      attachmentPreview.innerHTML = files.map(file => `
        <div class="attachment-item">
          <span>${escapeHtml(file.name)}</span>
          <span>${(file.size / 1024).toFixed(1)} KB</span>
        </div>
      `).join('');
    });

    function handleAnonymousToggle() {
      const isAnon = anonymousCheckbox.checked;
      [adviceName, adviceBuilding, adviceContact].forEach(input => {
        input.disabled = isAnon;
        input.classList.toggle('readonly-input', isAnon);
        input.required = !isAnon;
        if (isAnon) {
          input.value = '';
        }
      });
      fieldLabels.forEach(label => {
        label.classList.toggle('readonly-label', isAnon);
      });
    }

    // æäº¤è¡¨å•
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitMessage.innerHTML = '<div style="text-align: center; color: #666;">æ­£åœ¨æäº¤...</div>';
      
      const isAnonymous = anonymousCheckbox.checked;
      const name = adviceName.value.trim();
      const building = adviceBuilding.value.trim();
      const contact = adviceContact.value.trim();
      const description = adviceDescription.value.trim();
      const files = Array.from(adviceAttachments.files);

      if (!isAnonymous) {
        if (!name) {
          submitMessage.innerHTML = '<div class="error">å§“åä¸èƒ½ä¸ºç©º</div>';
          return;
        }

        if (!building) {
          submitMessage.innerHTML = '<div class="error">æ¥¼æ ‹å·ä¸èƒ½ä¸ºç©º</div>';
          return;
        }

        if (!contact) {
          submitMessage.innerHTML = '<div class="error">è”ç³»æ–¹å¼ä¸èƒ½ä¸ºç©º</div>';
          return;
        }

        const contactDigits = contact.replace(/\D/g, '');
        if (contactDigits.length !== 11) {
          submitMessage.innerHTML = '<div class="error">ç”µè¯å·ç å¿…é¡»æ˜¯11ä½æ•°å­—</div>';
          return;
        }
      }

      // éªŒè¯äº‹ä»¶æè¿°å­—æ•°ï¼ˆ1000ä¸ªæ±‰å­—ä»¥å†…ï¼‰
      const chineseCharCount = (description.match(/[\u4e00-\u9fa5]/g) || []).length;
      if (chineseCharCount > 1000) {
        submitMessage.innerHTML = '<div class="error">äº‹ä»¶æè¿°ä¸èƒ½è¶…è¿‡1000ä¸ªæ±‰å­—</div>';
        return;
      }

      if (files.length > 0) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        
        for (const file of files) {
          if (!allowedTypes.includes(file.type) && file.type !== '') {
            submitMessage.innerHTML = `<div class="error">æ–‡ä»¶ç±»å‹ä¸æ”¯æŒï¼š${escapeHtml(file.name)}</div>`;
            return;
          }
        }
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'æäº¤ä¸­...';

        // å‡†å¤‡æäº¤æ•°æ®
        const finalName = isAnonymous ? 'åŒ¿å' : name;
        const finalBuilding = isAnonymous ? 'åŒ¿åæ¥¼æ ‹' : building;
        const finalContact = isAnonymous ? '00000000000' : contact.replace(/\D/g, '');

        const adviceData = {
          name: finalName,
          building: finalBuilding,
          contact: finalContact,
          description,
          attachments: []
        };

        // å¦‚æœæœ‰é™„ä»¶ï¼Œä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
        if (files.length > 0) {
          const uploadPromises = files.map(async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('key', `advice-attachments/${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${file.name}`);

            // ä½¿ç”¨å…¬å¼€ä¸Šä¼ ç«¯ç‚¹
            const uploadResponse = await fetch('/api/upload-advice', {
              method: 'POST',
              body: formData
            });

            if (!uploadResponse.ok) {
              const error = await uploadResponse.json();
              throw new Error(error.error || 'é™„ä»¶ä¸Šä¼ å¤±è´¥');
            }

            const uploadData = await uploadResponse.json();
            
            // ç›´æ¥ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
            const directUploadFormData = new FormData();
            directUploadFormData.append('token', uploadData.uploadToken);
            directUploadFormData.append('key', uploadData.key);
            let uploadMime = file.type || '';
            if (!uploadMime && /\.txt$/i.test(file.name)) {
              uploadMime = 'text/plain; charset=utf-8';
            }
            if (uploadMime) {
              directUploadFormData.append('mimeType', uploadMime.includes('text/plain') && !uploadMime.includes('charset') ? 'text/plain; charset=utf-8' : uploadMime);
            }
            directUploadFormData.append('file', file);

            const directUploadResponse = await fetch('https://up-z2.qiniup.com/', {
              method: 'POST',
              body: directUploadFormData
            });

            if (!directUploadResponse.ok) {
              const errorText = await directUploadResponse.text();
              console.error('Direct upload failed:', errorText);
              throw new Error(`é™„ä»¶ä¸Šä¼ å¤±è´¥: ${errorText}`);
            }

            return {
              name: file.name,
              url: uploadData.url,
              size: file.size
            };
          });

          adviceData.attachments = await Promise.all(uploadPromises);
        }

        // æäº¤å»ºè¨€
        const response = await fetch('/api/advice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(adviceData)
        });

        if (response.ok) {
          submitMessage.innerHTML = '<div class="success">æäº¤æˆåŠŸï¼Œè¯·ç¨åæŸ¥çœ‹å›å¤åŠè¯„è®ºã€‚</div>';
          form.reset();
          attachmentPreview.innerHTML = '';
          adviceName.value = '';
          adviceBuilding.value = '';
          adviceContact.value = '';
          adviceDescription.value = '';
          descriptionCount.textContent = '0/1000 æ±‰å­—';
          descriptionCount.style.color = '#666';
          anonymousCheckbox.checked = false;
          handleAnonymousToggle();
          loadAdvices();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'æäº¤å¤±è´¥');
        }
      } catch (err) {
        console.error('Submit error:', err);
        submitMessage.innerHTML = `<div class="error">æäº¤å¤±è´¥ï¼š${err.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
      }
    });

    // åŠ è½½å»ºè¨€åˆ—è¡¨
    async function loadAdvices() {
      try {
        const response = await fetch('/api/advice');
        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
        
        const advices = await response.json();
        renderAdvices(advices);
      } catch (err) {
        console.error('Load error:', err);
        adviceList.innerHTML = '<p style="text-align: center; color: #666;">åŠ è½½å»ºè¨€å¤±è´¥</p>';
      }
    }

    // æ¸²æŸ“å»ºè¨€åˆ—è¡¨
    function renderAdvices(advices) {
      if (!advices || advices.length === 0) {
        adviceList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å»ºè¨€</p>';
        return;
      }

      // æŒ‰æ—¶é—´å€’åºæ’åˆ—
      advices.sort((a, b) => new Date(b.date) - new Date(a.date));

      const html = advices.map(advice => {
        const name = advice.name ?? advice.author ?? 'åŒ¿å';
        const building = advice.building ?? '';
        const contact = advice.contact ?? advice.title ?? '';
        const description = advice.description ?? advice.content ?? '';

        const displayTitle = `${maskName(name)} çš„ä¿¡æ¯`;

        const previewTextRaw = description ? description : 'ï¼ˆç”¨æˆ·æœªå¡«å†™äº‹ä»¶æè¿°ï¼‰';
        const preview = previewTextRaw.length > 60 ? previewTextRaw.slice(0, 60) + '...' : previewTextRaw;
        
        // è½¬ä¹‰ HTML å¹¶å¤„ç†è¶…é“¾æ¥
        const contentWithLinks = description
          ? escapeHtml(description).replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')
          : 'ï¼ˆç”¨æˆ·æœªå¡«å†™äº‹ä»¶æè¿°ï¼‰';
        
        const previewWithLinks = escapeHtml(preview).replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

        const pendingAttachments = Array.isArray(advice.pendingAttachments) ? advice.pendingAttachments : [];
        const pendingNote = pendingAttachments.length > 0
          ? `<div class="attachments" style="border-color:#ffe58a;background:#fffbe6;"><div style="font-weight:bold;margin-bottom:4px;">é™„ä»¶å®¡æ ¸ä¸­ï¼š</div>${pendingAttachments.map(att => `<div style="margin:4px 0;color:#888;">${escapeHtml(att.name)}</div>`).join('')}</div>`
          : '';

        const repliesHtml = Array.isArray(advice.replies) && advice.replies.length > 0
          ? `<div class="attachments" style="border-top:none;margin-top:8px;padding-top:0;">${advice.replies.map(r => {
              const d = r.date ? new Date(r.date) : null;
              const dateStr = d && !isNaN(d) ? `${d.getFullYear()}å¹´${(d.getMonth()+1).toString().padStart(2,'0')}æœˆ${d.getDate().toString().padStart(2,'0')}æ—¥` : '';
              return `<div style="margin:6px 0;">
                <span style="color:#d00;font-weight:bold;margin-right:6px;">ä¸šå§”ä¼šå›å¤</span>
                ${dateStr ? `<span style="color:#888;font-size:0.85rem;margin-right:6px;">${dateStr}</span>` : ''}
                <span>${escapeHtml(r.content)}</span>
              </div>`;
            }).join('')}</div>`
          : '';

        const commentsHtml = Array.isArray(advice.comments) && advice.comments.length > 0
          ? `<div class="attachments"><div style="font-weight:bold;margin-bottom:6px;">è¯„è®ºï¼š</div>${advice.comments.map(c => {
              const d = c.date ? new Date(c.date) : null;
              const dateStr = d && !isNaN(d) ? `${d.getFullYear()}å¹´${(d.getMonth()+1).toString().padStart(2,'0')}æœˆ${d.getDate().toString().padStart(2,'0')}æ—¥ ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}` : '';
              return `<div style="margin:4px 0;"><span style="color:#555;margin-right:6px;">${escapeHtml(c.author || 'åŒ¿å')}</span>${dateStr ? `<span style="color:#888;font-size:0.85rem;margin-right:6px;">${dateStr}</span>` : ''}<span>${escapeHtml(c.content)}</span></div>`;
            }).join('')}</div>`
          : '';

        const commentForm = `<div class="comment-box" onclick="event.stopPropagation();">
          <div style="font-weight:bold;margin:2px 0;">æˆ‘è¦è¯„è®ºï¼š</div>
          <div style="margin:2px 0;" onclick="event.stopPropagation();">
            <input type="text" id="c-author-${advice.id}" class="comment-author-input" placeholder="ç½‘åï¼ˆå¯é€‰ï¼‰" style="width:100%; max-width: 360px;" />
          </div>
          <div style="margin:2px 0;" onclick="event.stopPropagation();">
            <textarea id="c-content-${advice.id}" class="comment-content-input" placeholder="è¯„è®ºå†…å®¹" style="width:100%;"></textarea>
          </div>
          <div style="margin:2px 0;" onclick="event.stopPropagation();">
            <button class="comment-submit-btn" onclick="event.stopPropagation(); submitComment('${advice.id}')">æäº¤</button>
          </div>
          <div id="c-msg-${advice.id}" style="font-size:0.85rem;color:#666;margin:2px 0;"></div>
        </div>`;

        return `<div class="advice-item">
          <div class="advice-title" onclick="toggleAdvice('${advice.id}')">${escapeHtml(displayTitle)}</div>
          <div class="advice-meta">å§“åï¼š${escapeHtml(maskName(name))} | æ¥¼æ ‹å·ï¼š**** | è”ç³»æ–¹å¼ï¼š${escapeHtml(maskContact(contact))} | æ—¶é—´ï¼š${new Date(advice.date).toLocaleString('zh-CN')}</div>
          <div class="advice-content preview" id="content-${advice.id}">${previewWithLinks}</div>
          <div class="advice-content full" id="full-content-${advice.id}" style="display: none;">
            <div class="advice-detail-block">
              <div class="advice-detail-line">å§“åï¼š${escapeHtml(maskName(name))}</div>
              <div class="advice-detail-line">æ¥¼æ ‹å·ï¼š****</div>
              <div class="advice-detail-line">è”ç³»æ–¹å¼ï¼š${escapeHtml(maskContact(contact))}</div>
              <div class="advice-detail-line">æäº¤æ—¶é—´ï¼š${new Date(advice.date).toLocaleString('zh-CN')}</div>
            </div>
            ${contentWithLinks}
            ${pendingNote}
            ${repliesHtml}
            ${renderAttachments(advice.attachments)}
            ${commentsHtml}
            ${commentForm}
          </div>
        </div>`;
      }).join('');

      adviceList.innerHTML = html;
    }

    // æ¸²æŸ“é™„ä»¶
    function renderAttachments(attachments) {
      if (!attachments || attachments.length === 0) return '';
      
      return `<div class="attachments"><div style="font-weight: bold; margin-bottom: 8px;">é™„ä»¶ï¼š</div>${attachments.map(attachment => {
        const escapedUrl = attachment.url.replace(/\"/g, '&quot;').replace(/'/g, '&#39;');
        const isWord = /\.(docx?)$/i.test(attachment.name || '');
        const officeViewer = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(attachment.url)}`;
        const viewUrl = isWord ? officeViewer : escapedUrl;
        return `<div class="attachment-item"><a href="${viewUrl}" target="_blank" style="display: flex; align-items: center; gap: 8px; color: #0077cc; text-decoration: none; flex: 1;"><span class="attachment-icon">ğŸ“</span><span>${escapeHtml(attachment.name)}</span></a><a href="${escapedUrl}" download="${escapeHtml(attachment.name)}" class="attachment-download-btn">ä¸‹è½½</a><span style="color: #999; margin-left: 8px;">(${formatFileSize(attachment.size)})</span></div>`;
      }).join('')}</div>`;
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // åˆ‡æ¢å»ºè¨€å†…å®¹æ˜¾ç¤º
    window.toggleAdvice = function(id) {
      const previewEl = document.getElementById(`content-${id}`);
      const fullEl = document.getElementById(`full-content-${id}`);
      
      if (fullEl.style.display === 'block') {
        // æ”¶èµ·
        fullEl.style.display = 'none';
        previewEl.style.display = 'block';
      } else {
        // å±•å¼€
        previewEl.style.display = 'none';
        fullEl.style.display = 'block';
      }
    };

    // è½¬ä¹‰ HTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    // æäº¤è¯„è®º
    window.submitComment = async function(id) {
      const authorInput = document.getElementById(`c-author-${id}`);
      const contentInput = document.getElementById(`c-content-${id}`);
      const msgEl = document.getElementById(`c-msg-${id}`);
      const author = (authorInput?.value || '').trim();
      const content = (contentInput?.value || '').trim();
      if (!content) {
        msgEl.textContent = 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º';
        msgEl.style.color = '#dc3545';
        return;
      }
      msgEl.textContent = 'æ­£åœ¨æäº¤...';
      msgEl.style.color = '#666';
      try {
        const res = await fetch('/api/advice-comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adviceId: id, author, content })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'æäº¤å¤±è´¥');
        }
        msgEl.textContent = 'æäº¤æˆåŠŸ';
        msgEl.style.color = '#28a745';
        if (authorInput) authorInput.value = '';
        if (contentInput) contentInput.value = '';
        // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°è¯„è®º
        loadAdvices();
      } catch (e) {
        msgEl.textContent = `æäº¤å¤±è´¥ï¼š${e.message}`;
        msgEl.style.color = '#dc3545';
      }
    }

    function maskName(name) {
      if (!name) return 'åŒ¿å';
      const trimmed = name.trim();
      return trimmed.charAt(0) + '****';
    }

    function maskContact(contact) {
      if (!contact) return '****';
      const digits = contact.replace(/\D/g, '');
      if (digits.length < 7) return contact;
      const start = digits.slice(0, 3);
      const end = digits.slice(-4);
      return `${start}****${end}`;
    }

    // åˆå§‹åŒ–
    loadAdvices();
  </script>
</body>
</html>
